function map(i,t,s,e,h){return e+(h-e)*(i-t)/(s-t)}function preload(){imgWorldmap=loadImage("img/worldmap.jpg")}function setup(){createCanvas(winW,winH).parent("canvas-block"),pixelDensity(1),frameRate(0),kSetup()}function kSetup(){frameRate(0),$("#canvas-cover").fadeIn("fast");var i=$("#select-time").val(),t="https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/"+$("#select-mag").val()+"_"+i+".geojson";$.getJSON(t).done(function(i){switch(json=i,$("#select-time").val()){case"hour":duration=36e5;break;case"day":duration=864e5;break;case"week":duration=6048e5;break;case"month":duration=2592e6;break;default:duration=0}objWorldmap=new worldmap(0,0,winW,winW/2),objButton=new button(0,mapH,btnW,winH-mapH),objSlider=new slider(btnW,mapH,winW-btnW,winH-mapH),objQuakes=new Array(json.features.length);for(var t=0;t<objQuakes.length;t++){var s=json.features[t],e=s.properties.time,h=s.geometry.coordinates[1],o=s.geometry.coordinates[0],a=s.properties.mag,r=s.geometry.coordinates[2],l=s.properties.url,n=s.properties.place,m=s.properties.status;objQuakes[t]=new quake(t,e,h,o,a,r,l,n,m)}frameRate(60),$("#canvas-cover").fadeOut("fast")})}function draw(){background(color(COLORS.background)),objWorldmap.display(),objButton.display(),objSlider.display();for(var i=0;i<objQuakes.length;i++)objQuakes[i].display();isClicking=!1}function worldmap(i,t,s,e){this.x=i,this.y=t,this.w=s,this.h=e,this.display=function(){tint(100,120,140),image(imgWorldmap,this.x,this.y,this.w,this.h)}}function button(i,t,s,e){this.b=10*wBase,this.x=i+this.b,this.y=t+this.b,this.w=s-2*this.b,this.h=e-2*this.b,this.display=function(){this.hover=!1,noFill(),this.x<=mouseX&&mouseX<=this.x+this.w&&this.y<=mouseY&&mouseY<=this.y+this.h&&(this.hover=!0,fill(250,250,250,20)),this.hover&&isClicking&&(isPlaying=!isPlaying),strokeWeight(2),stroke(color(COLORS.blue)),rect(this.x,this.y,this.w,this.h,5*wBase),isPlaying?(objSlider.cx+=1,objSlider.cx>objSlider.max&&(objSlider.cx=objSlider.max,isPlaying=!1),rectMode(RADIUS),fill(color(COLORS.blue)),noStroke(),this.wh=6*wBase,rect(this.x+this.w/2,this.y+this.h/2,this.wh,this.wh),rectMode(CORNER)):(fill(color(COLORS.blue)),noStroke(),this.bx=24*wBase,this.by=8*wBase,triangle(this.x+this.bx,this.y+this.by,this.x+this.bx,this.y+this.h-this.by,this.x+this.w-this.bx,this.y+this.h/2))}}function slider(i,t,s,e){this.x=i,this.y=t,this.w=s,this.h=e,this.min=this.x+20*wBase,this.max=this.x+this.w-20*wBase,this.cx=this.min,this.cy=this.y+this.h/2,this.cr=30*wBase,this.maxTime=json.metadata.generated,this.minTime=this.maxTime-duration,this.value=this.minTime,this.hover=!1,this.display=function(){this.hover=!1,this.x<=mouseX&&mouseX<=this.x+this.w&&this.y<=mouseY&&mouseY<=this.y+this.h&&(this.hover=!0),this.hover&&mouseIsPressed&&(this.cx=max(min(mouseX,this.max),this.min)),stroke(150,150,150),strokeWeight(6),line(this.min,this.y+this.h/2,this.max,this.y+this.h/2),stroke(200,100,100),line(this.min,this.y+this.h/2,this.cx,this.y+this.h/2),stroke(color(COLORS.yellow)),strokeWeight(3),fill(color(COLORS.white)),ellipse(this.cx,this.cy,this.cr,this.cr),this.value=map(this.cx,this.min,this.max,this.minTime,this.maxTime),showDatetime(this.value)}}function quake(i,t,s,e,h,o,a,r,l){this.i=i,this.msc=t,this.lat=s,this.lng=e,this.mag=h,this.dep=o,this.url=a,this.place=r,this.status=l,this.x=map(this.lng,-180,180,objWorldmap.x,objWorldmap.x+objWorldmap.w),this.y=map(this.lat,90,-90,objWorldmap.y,objWorldmap.y+objWorldmap.h),this.r=map(this.mag,0,9,3,30),this.wr=3*this.r,this.display=function(){this.hover=!1,this.dif=this.msc-objSlider.value,this.max=.02*duration,-1*this.max<=this.dif&&this.dif<=0&&(this.ewr=map(this.dif,-1*this.max,0,this.wr,0),this.alp=255,this.dif<=-.5*this.max&&(this.alp=map(this.dif,-1*this.max,-.5*this.max,100,255)),noFill(),stroke(255,100,100,this.alp),strokeWeight(1),ellipse(this.x,this.y,this.ewr,this.ewr),dist(mouseX,mouseY,this.x,this.y)<=this.r&&(this.hover=!0),this.hover?(fill(255,255,100,this.alp),showTooltip(this.x,this.y,this.msc,this.lat,this.lng,this.mag,this.dep,this.url,this.place,this.status),hoveredQuakeIndex=this.i):(fill(230,this.alp),hoveredQuakeIndex==this.i&&hideTooltip()),stroke(255,100,100,this.alp),strokeWeight(1),ellipse(this.x,this.y,this.r,this.r))}}function getDateStr(i){var t=new Date;t.setTime(i);return t.getFullYear()+"-"+("0"+(t.getMonth()+1)).slice(-2)+"-"+("0"+t.getDate()).slice(-2)+" "+("0"+t.getHours()).slice(-2)+":"+("0"+t.getMinutes()).slice(-2)+":"+("0"+t.getSeconds()).slice(-2)}function showDatetime(i){this.x=objWorldmap.x+objWorldmap.w/2,this.y=objWorldmap.y+objWorldmap.h-10,this.w=200*wBase,this.h=25*wBase,noStroke(),fill(0,0,0,180),rect(this.x-this.w/2,this.y-this.h+4*wBase,this.w,this.h,this.h/2),fill(color(COLORS.white)),textAlign(CENTER,BOTTOM),text(getDateStr(i),objWorldmap.x+objWorldmap.w/2,objWorldmap.y+objWorldmap.h-10*wBase)}function mousePressed(){isClicking=!0}function showTooltip(i,t,s,e,h,o,a,r,l,n){$("#tooltip-inner").html("<div class='title'>"+l+"</div><div>Date & time: "+getDateStr(s)+"</div><div>Magnitude: "+o+"</div><div>Latitude: "+e+"</div><div>Longitude: "+h+"</div><div>Depth: "+a+"km</div><div>Status: "+n+"</div>");var m=i+$("canvas").offset().left-$("#tooltip").width()/2-12,d=t+$("canvas").offset().top-$(window).scrollTop()+20;$("#tooltip").css("left",m+"px"),$("#tooltip").css("top",d+"px"),$("#tooltip").show()}function hideTooltip(){$("#tooltip").hide()}var json,objWorldmap,objSlider,objButton,objQuakes,imgWorldmap,winW=$("#canvas").width(),wBase=winW/720,winH=410*wBase,mapH=360*wBase,btnW=80*wBase,isSetup=!1,isPlaying=!1,isClicking=!1,duration=0,hoveredQuakeIndex=-1,COLORS={background:[10,20,30],blue:[130,206,238],yellow:[239,169,41],white:[250,250,250],red:[240,100,100],grey:[150,150,150]};$(function(){$("select").on("change",function(){kSetup()})});