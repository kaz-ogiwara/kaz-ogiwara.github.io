var kCanvas={w:$("#canvas").width(),h:$("#canvas").height()},kBlocks=[],kCurves=[],kCover,kInfo,isStarted=!1,COUNTRIES=[],COLORS={white:"#fefefe",background:"rgb(10,30,60)",curve:{diff:"#fafafa",same:"#fafafa"}};function addCommas(num){return String(num).replace(/(\d)(?=(\d\d\d)+(?!\d))/g,"$1,")}function map(value,low1,high1,low2,high2){var ret;return low2+(high2-low2)*(value-low1)/(high1-low1)}function mapValueY(value){var TOTAL_VALUE=46896,ret;return map(value,0,46896,0,kCanvas.h/2)}function setup(){var canvas;createCanvas(kCanvas.w,kCanvas.h).parent("canvas"),background(COLORS.background),pixelDensity(1),frameRate(0),$.getJSON("data/data.json",function(data){COUNTRIES=data.countries,kBlocks.froms=[],kBlocks.tos=[];var i=0;$.each(data.froms,function(key,value){kBlocks.froms[i]=new block(i,"from",key,value),i++}),i=0,$.each(data.tos,function(key,value){kBlocks.tos[i]=new block(i,"to",key,value),i++});for(var i=0;i<data.curves.length;i++)kCurves[i]=new kCurve(i,data.curves[i]);kCover=new kCover,kInfo=new kInfo,isStarted=!0,frameRate(60)})}function draw(){isStarted&&(clear(),kBlocks.froms.forEach(function(block){block.display()}),kBlocks.tos.forEach(function(block){block.display()}),kCurves.forEach(function(curve){curve.display()}),kCover.display(),kInfo.display())}function block(i,type,code,value){this.i=i,this.type=type,this.code=code,this.name=COUNTRIES[code],this.value=value,this.blank=0,this.cur=0,this.name||(this.name=""),this.hovered=!1,this.x=this.blank,this.y=0,this.w=40,this.h=mapValueY(this.value.total);var prev=kBlocks[this.type+"s"][i-1];prev&&(this.y=prev.y+prev.h),"to"===this.type&&(this.x=kCanvas.w-this.blank-this.w),this.cr=100+15*this.i,this.cg=200+15*this.i,this.cb=200+15*this.i,"to"===this.type&&(this.cr=200+15*this.i,this.cg=200+15*this.i,this.cb=100+15*this.i),this.tm=4,this.tx=this.x+this.w+this.tm,this.ty=this.y+this.h/2,"to"===this.type&&(this.tx=this.x-this.tm),this.display=function(){if(textSize(13),noStroke(),fill(120),textAlign(LEFT,CENTER),"to"===this.type&&textAlign(RIGHT,CENTER),fill(this.cr,this.cg,this.cb),strokeWeight(1),stroke(COLORS.background),strokeCap(SQUARE),rectMode(CORNER),this.x<=mouseX&&mouseX<=this.x+this.w&&this.y<=mouseY&&mouseY<=this.y+this.h){for(var i=0;i<kCurves.length;i++)"from"===this.type&&this.code===kCurves[i].from?kCurves[i].show=!0:"to"===this.type&&this.code===kCurves[i].to?kCurves[i].show=!0:kCurves[i].show=!1;kCover.isMoving||(kCover.isMoving=!0),this!==kCover.hoveredBlock&&(kCover.millis=millis(),kCover.hoveredBlock=this,drawMapWithData(this.code),updateInfo(this.type,this.code,this.value,this.name))}this===kCover.hoveredBlock&&fill(200,100,100),rect(this.x,this.y,this.w,this.h)}}function kCurve(i,data){var toBlock,fromBlock;this.i=i,this.from=data[0],this.to=data[1],this.value=data[2],this.show=!1,kBlocks.froms.forEach(function(block){block.code===data[0]&&(fromBlock=block)}),kBlocks.tos.forEach(function(block){block.code===data[1]&&(toBlock=block)}),this.xb=4,this.h=mapValueY(this.value),fromBlock&&toBlock&&(this.x1=kBlocks.froms[0].w+kBlocks.froms[0].blank+this.xb,this.y1=fromBlock.y+fromBlock.cur+this.h/2,this.x2=map(5,0,10,this.x1,kCanvas.w-kBlocks.froms[0].w-kBlocks.froms[0].blank-4),this.y2=this.y1,this.x3=this.x2,this.y3=toBlock.y+toBlock.cur+this.h/2,this.x4=kBlocks.tos[0].x-this.xb,this.y4=this.y3,fromBlock.cur+=this.h,toBlock.cur+=this.h),this.display=function(){fromBlock&&toBlock&&this.show&&(strokeWeight(this.h),stroke(200,100,100,230),noFill(),bezier(this.x1,this.y1,this.x2,this.y2,this.x3,this.y3,this.x4,this.y4))}}function kCover(){this.x=kBlocks.froms[0].w+kBlocks.froms[0].blank+1,this.y=0,this.w=kCanvas.w-2*this.x,this.h=kCanvas.h,this.isMoving=!1,this.millis=0,this.duration=800,this.hoveredBlock,this.display=function(){this.isMoving&&(this.r=map(millis()-this.millis,0,this.duration,1,0),0<=this.r&&this.r<=1?(this.tw=this.r*this.w,this.tx=this.x+this.w-this.tw,noStroke(),fill(COLORS.background),rect(this.tx,this.y,this.tw,this.h)):(this.isMoving=!1,this.millis=0))}}function kInfo(){this.type="",this.code="",this.name="",this.data={},this.x=0,this.y=560,this.title={x:this.x,y:this.y+8},this.total={x:this.x,y:this.y+16},this.gender={x:this.x,y:this.y+100},this.age={x:this.x,y:this.y+240},this.labour={x:this.x+.2*kCanvas.w,y:this.y+16},this.control={x:this.x+.4*kCanvas.w,y:this.y+16},this.recruiter={x:this.x+.6*kCanvas.w,y:this.y+16},this.exploitation={x:this.x+.8*kCanvas.w,y:this.y+16},this.citizenship={x:this.x+.8*kCanvas.w,y:this.y+16},this.display=function(){stroke(120),strokeWeight(2),line(this.x,this.y,this.x+kCanvas.w,this.y),fill(240),noStroke(),textSize(54),textAlign(LEFT,BOTTOM),text(this.type+" "+this.name,this.title.x,this.title.y),showCategory("total","Total Number"),showCategory("gender","Gender"),showCategory("age","Age"),showCategory("control","Means of Control"),showCategory("labour","Type of Labour"),showCategory("recruiter","Recruiter");let totalNum=this.data.total;kCover.isMoving&&(totalNum=Math.floor((1-kCover.r)*totalNum)),fill(240),noStroke(),textSize(24),textAlign(RIGHT,TOP),text(addCommas(totalNum),this.total.x+110,this.total.y+20),"to"===this.type?showCategory("citizenship","Citizenship"):showCategory("exploitation","Country of Exploitation")}}function getCountryName(code){var ret="Unknown";return COUNTRIES[code]&&(ret=COUNTRIES[code].toString()),ret}function showCategory(code,name){if(fill(240),textSize(16),noStroke(),textAlign(LEFT,TOP),text(name,kInfo[code].x,kInfo[code].y),kInfo.data[code]){var i=0;for(key in kInfo.data[code])showValue(i,kInfo[code].x,kInfo[code].y,code,key),i++}}function showValue(i,x,y,code,name){let kData=kInfo.data[code],value=kData[name],denom=0;for(var key in kData)denom<kData[key]&&(denom=kData[key]);"exploitation"!==code&&"citizenship"!==code||(name=getCountryName(name)),kCover.isMoving&&(value=(1-kCover.r)*value);let boxw=map(value,0,denom,0,120);value=Math.floor(value),noStroke(),textAlign(LEFT,TOP),fill(255,0,7),fill(200,230,240),textSize(13),text(name,x,y+54*i+30),fill(240,240,200),textSize(14),textAlign(RIGHT,TOP),text(addCommas(value),x+42,y+54*i+20+30),noStroke(),fill(120,140,180),rect(x+46,y+54*i+54,boxw,8,4)}function updateInfo(kType,kCode,kValue,kName){kInfo.type=kType,kInfo.code=kCode,kInfo.data=kValue,kInfo.name=kName}